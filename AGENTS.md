# AGENTS.md

This file provides guidance to AI coding agents when working with code in this repository.

## Repository Overview

This is a collection of reusable Terraform modules for personal development across multiple cloud providers and services. Modules are designed to be consumed via Git references with specific commit SHAs:

```hcl
module "example" {
  source = "git::https://github.com/tnoff/terraform-modules.git///<provider>/<module-name>?ref=<commit-sha>"
}
```

## Module Structure

The repository is organized by provider at the top level:
- `cloudflare/` - DNS management modules
- `github/` - GitHub repository and webhook management
- `discord/` - Discord server management (roles, channels, permissions)
- `oci/` - Oracle Cloud Infrastructure modules (IAM, OKE, storage, networking, bastion)
- `kubernetes/` - Kubernetes-related modules (OCIR image pull secrets)

Each module follows standard Terraform structure:
- `main.tf` - Primary resource definitions
- `variables.tf` - Input variable declarations
- `outputs.tf` or `output.tf` - Output value definitions (naming varies)
- `provider.tf` - Provider version constraints
- `terraform.md` - Auto-generated documentation (DO NOT manually edit)

## Development Commands

### Pre-commit Hooks

Install pre-commit hooks (required for development):
```bash
pre-commit install
```

### Formatting

Format all Terraform files:
```bash
docker run --rm -v "$(pwd):/workspace" -w /workspace hashicorp/terraform:1.11 fmt -write=true -recursive
```

Or use pre-commit hook (runs automatically on commit):
```bash
pre-commit run terraform-fmt --all-files
```

### Documentation Generation

Generate/update terraform.md files for all providers:
```bash
# For each provider directory (cloudflare, discord, github, kubernetes, oci)
docker run --rm -v "$(pwd):/workspace" -w /workspace quay.io/terraform-docs/terraform-docs:0.19.0 <provider-dir>/
```

Or use pre-commit hooks (runs automatically on commit):
```bash
pre-commit run terraform-docs-cloudflare --all-files
pre-commit run terraform-docs-discord --all-files
pre-commit run terraform-docs-github --all-files
pre-commit run terraform-docs-kubernetes --all-files
pre-commit run terraform-docs-oci --all-files
```

Configuration for terraform-docs is in `.terraform-docs.yml`:
- Recursive mode enabled
- Output format: markdown table
- Injects documentation into `terraform.md` files

### Validation

Check if terraform-docs output is up to date:
```bash
./.pre-commit-scripts/check-terraform-docs.sh <provider-dir>
```

## Provider Configuration

### Cloudflare
- Provider: `cloudflare/cloudflare` ~> 5
- Terraform: ~> 1.9
- Auth: Cloudflare API token

### GitHub
- Provider: `integrations/github` ~> 6.0
- Terraform: ~> 1.9
- Auth: GitHub personal access token

### Discord
- Provider: `Lucky3028/discord` ~> 2.0
- Auth: Discord bot token with appropriate server permissions

### OCI (Oracle Cloud Infrastructure)
- Provider: `oracle/oci` ~> 6.20
- Terraform: ~> 1.9
- Auth: User OCID, tenancy OCID, private key, fingerprint, region

### Kubernetes
- Used in conjunction with OCI modules for OCIR integration

## Module Design Patterns

### Resource Naming
Most modules use a consistent pattern where the primary resource is named `this` and dynamically generated resources use `for_each` with descriptive names.

### Common Variables
- `freeform_tags` - Used across OCI modules for resource tagging
- `var.name` prefix pattern - Many OCI resources append "-cluster", "-pool", etc. to base names

### GitHub Modules
- `github-repo`: Creates repositories with sensible defaults (no merge commits, delete branch on merge, vulnerability alerts enabled)
- Supports dynamic injection of action secrets, variables, labels, and topics via `for_each` loops
- Includes branch protection via repository rulesets

### Discord Modules
- Permission management uses data sources for `allow_channel` and `deny_channel` permission bits
- Channel groups support both allowed and denied role lists
- Resources use position-based ordering for channels

### OCI Modules
- OKE (Oracle Kubernetes Engine) modules are split across cluster, networking, and node pool
- IAM modules handle compartments and users
- Object storage includes bucket and lifecycle policy management
- Container registry support for OCI Registry

## Important Notes

- **Never manually edit `terraform.md` files** - These are auto-generated by terraform-docs
- Pre-commit hooks run Docker containers - ensure Docker is available
- All pre-commit hooks use `pass_filenames: false` and operate on directories, not individual files
- The repository does not use a main/master branch by default - check git config for branch naming
